--EX.11
USE MASTER
CREATE DATABASE PLANO_S
USE PLANO_S

CREATE TABLE PLANOS_DE_SAUDE(
CODIGO			INT					NOT NULL,
NOME			VARCHAR(20)			NOT NULL,
TELEFONE		CHAR(08)			NOT NULL
PRIMARY KEY (CODIGO)
)
INSERT INTO PLANOS_DE_SAUDE
VALUES
(1234,'Amil','41599856'),
(2345,'Sul América','45698745'),
(3456,'Unimed','48759836'),
(4567,'Bradesco Saúde','47265897'),
(5678,'Intermédica','41415269')

CREATE TABLE PACIENTE(
CPF				VARCHAR(11)			NOT NULL,
NOME			VARCHAR(15)			NOT NULL,
RUA				VARCHAR(50)			NOT NULL,
NUMERO			INT					NOT NULL,
BAIRRO			VARCHAR(15)			NOT NULL,
TELEFONE		CHAR(08)			NOT NULL,
PLANSAU			INT					NOT NULL
PRIMARY KEY (CPF)
FOREIGN KEY (PLANSAU)
			REFERENCES PLANOS_DE_SAUDE (CODIGO)
)
INSERT INTO PACIENTE
VALUES
('85987458920','Maria Paula','R. Voluntários da Pátria',589,'Santana','98458741',2345),
('87452136900','Ana Julia','R. XV de Novembro',657,'Centro','69857412',5678),
('23659874100','João Carlos','R. Sete de Setembro',12,'República','74859632',1234),
('63259874100','José Lima','R. Anhaia',768,'Barra Funda','96524156',2345)

CREATE TABLE MEDICO(
CODIGO				INT				NOT NULL,
NOME				VARCHAR(15)		NOT NULL,
ESPECIALIDADE		VARCHAR(35)		NOT NULL,
PLANSAU				INT				NOT NULL
PRIMARY KEY (CODIGO)
FOREIGN KEY (PLANSAU)
			REFERENCES PLANOS_DE_SAUDE (CODIGO)

)
INSERT INTO MEDICO
VALUES
(1,'Claudio','Clínico Geral',1234),
(2,'Larissa','Ortopedista',2345),
(3,'Juliana','Otorrinolaringologista',4567),
(4,'Sérgio','Pediatra',1234),
(5,'Julio','Clínico Geral',4567),
(6,'Samara','Cirurgião',1234)

CREATE TABLE CONSULTAS(
MEDICO				INT					NOT NULL,
PACIENTE			CHAR(11)			NOT NULL,
DATAHORA			DATE				NOT NULL,
DIAGNOSTICO			VARCHAR(15)			NOT NULL
PRIMARY KEY (MEDICO,PACIENTE,DATAHORA)
FOREIGN KEY (MEDICO)
		REFERENCES MEDICO (CODIGO),
FOREIGN KEY (PACIENTE)
		REFERENCES PACIENTE (CPF)
)
ALTER TABLE CONSULTAS
ALTER COLUMN DATAHORA		DATETIME		NOT NULL

ALTER TABLE CONSULTAS
ALTER COLUMN PACIENTE		VARCHAR(11)		NOT NULL

INSERT INTO CONSULTAS
VALUES
(1,'85987458920','2021-02-10 10:30:00','Gripe'),
(2,'23659874100','2021-02-10 11:00:00','Pé Fraturado'),
(4,'85987458920','2021-02-11 14:00:00','Pneumonia'),
(1,'23659874100','2021-02-11 15:00:00','Asma'),
(3,'87452136900','2021-02-11 16:00:00','Sinusite'),
(5,'63259874100','2021-02-11 17:00:00','Rinite'),
(4,'23659874100','2021-02-11 18:00:00','Asma'),
(5,'63259874100','2021-02-12 10:00:00','Rinoplastia')

--OP1
SELECT M.NOME,M.ESPECIALIDADE FROM MEDICO M
INNER JOIN PLANOS_DE_SAUDE PS
ON PS.CODIGO = M.PLANSAU
WHERE PS.NOME = 'Amil'
--OP2
SELECT P.NOME,P.RUA+' '+CAST(P.NUMERO AS VARCHAR(5))+' '+P.BAIRRO AS ENDERECO,
P.TELEFONE, PS.NOME
FROM PACIENTE P
INNER JOIN PLANOS_DE_SAUDE PS
ON PS.CODIGO = P.PLANSAU
--OP3
SELECT PS.TELEFONE FROM PACIENTE P
INNER JOIN PLANOS_DE_SAUDE PS
ON PS.CODIGO = P.PLANSAU
WHERE P.NOME = 'Ana Julia'
--OP4
SELECT * FROM PLANOS_DE_SAUDE PS
LEFT OUTER JOIN PACIENTE P
ON PS.CODIGO = P.PLANSAU
WHERE P.PLANSAU IS NULL
--OP5
SELECT * FROM PLANOS_DE_SAUDE PS
LEFT OUTER JOIN MEDICO M
ON PS.CODIGO = M.PLANSAU
WHERE M.PLANSAU IS NULL
--OP6
SELECT SUBSTRING(CAST(C.DATAHORA AS VARCHAR(11)),1,11) AS DATA,
RIGHT(CAST(C.DATAHORA AS VARCHAR(20)),8) AS HORA,
M.NOME AS NOME_MEDICO,
P.NOME AS PACIENTE_NOME,
C.DIAGNOSTICO
FROM CONSULTAS C
INNER JOIN MEDICO M ON M.CODIGO = C.MEDICO
INNER JOIN PACIENTE P ON P.CPF = C.PACIENTE
--OP7
SELECT M.NOME AS NOME_MEDICO,
SUBSTRING(CAST(C.DATAHORA AS VARCHAR(11)),1,11) AS DATA,
RIGHT(CAST(C.DATAHORA AS VARCHAR(20)),8) AS HORA,
C.DIAGNOSTICO
FROM CONSULTAS C
INNER JOIN MEDICO M ON M.CODIGO = C.MEDICO
INNER JOIN PACIENTE P ON P.CPF = C.PACIENTE
WHERE P.NOME = 'José Lima'
--OP8
SELECT DISTINCT C.DIAGNOSTICO,COUNT(C.DIAGNOSTICO) AS QTD FROM CONSULTAS C
GROUP BY C.DIAGNOSTICO
--OP9
SELECT COUNT(PS.CODIGO) FROM PLANOS_DE_SAUDE PS
LEFT OUTER JOIN MEDICO M
ON M.PLANSAU = PS.CODIGO
WHERE M.PLANSAU  IS NULL
--OP10
ALTER TABLE PACIENTE
ALTER COLUMN NOME		VARCHAR(25)		NOT NULL
UPDATE PACIENTE
SET NOME = 'João Carlos da Silva'
WHERE 
NOME = 'João Carlos'
GO
SELECT * FROM PACIENTE P
WHERE P.NOME = 'João Carlos da Silva'
--OP11
DELETE FROM PLANOS_DE_SAUDE
WHERE NOME = 'Unimed'
GO
SELECT * FROM PLANOS_DE_SAUDE
--OP12
EXEC sp_rename 'PACIENTE.RUA','Logradouro','column'
EXEC SP_HELP PACIENTE
--OP13
SELECT * FROM PACIENTE
ALTER TABLE PACIENTE
ADD DATA_NASC		DATE		NULL

UPDATE PACIENTE
SET DATA_NASC = '1990-04-18'
WHERE CPF = '23659874100'
GO
UPDATE PACIENTE
SET DATA_NASC = '1981-03-25'
WHERE CPF = '63259874100'
GO
UPDATE PACIENTE
SET DATA_NASC = '2004-09-04 '
WHERE CPF = '85987458920'
GO
UPDATE PACIENTE
SET DATA_NASC = '1986-06-18'
WHERE CPF = '87452136900'