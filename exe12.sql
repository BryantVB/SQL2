--EX.12
USE MASTER
CREATE DATABASE SERVICO_CONTRATO
USE SERVICO_CONTRATO

CREATE TABLE PLANOS(
CODPLANO		INT				NOT NULL,
NOMEPLANO		VARCHAR(15)		NOT NULL,
VALPLANO		INT				NOT NULL
PRIMARY KEY (CODPLANO)
)
INSERT INTO PLANOS
VALUES
(1,'100 Minutos',80),
(2,'150 Minutos',130),
(3,'200 Minutos',160),
(4,'250 Minutos',220),
(5,'300 Minutos',260),
(6,'600 Minutos',350)

CREATE TABLE SERVICOS(
CODSERVICO		INT				NOT NULL,		
NOMESERVICO		VARCHAR(20)		NOT NULL,
VALORSERVICO	INT				NOT NULL
PRIMARY KEY (CODSERVICO)
)
INSERT INTO SERVICOS
VALUES
(1,'100 SMS',10),
(2,'SMS Ilimitado',30),
(3,'Internet 500 MB',40),
(4,'Internet 1 GB',60),
(5,'Internet 2 GB',70)

CREATE TABLE CLIENTE(
CODCLIENTE		INT				NOT NULL,
NOMECLIENTE		VARCHAR(20)		NOT NULL,
DATINI			DATE			NOT NULL
PRIMARY KEY (CODCLIENTE)
)
INSERT INTO CLIENTE
VALUES
(1234,'Cliente A','2012-10-15'),
(2468,'Cliente B','2012-11-20'),
(3702,'Cliente C','2012-11-25'),
(4936,'Cliente D','2012-12-01'),
(6170,'Cliente E','2012-12-18'),
(7404,'Cliente F','2013-01-20'),
(8638,'Cliente G','2013-01-25')

CREATE TABLE CONTRATO(
CODCLIENTE		INT				NOT NULL,
CODPLANO		INT				NOT NULL,
CODSERVICO		INT				NOT NULL,
STATUS			CHAR(01)		NOT NULL,
DAT				DATE			NOT NULL
PRIMARY KEY (CODCLIENTE,CODPLANO,CODSERVICO,DAT)
FOREIGN KEY (CODCLIENTE)
			REFERENCES CLIENTE (CODCLIENTE),
FOREIGN KEY (CODPLANO)
			REFERENCES PLANOS (CODPLANO),
FOREIGN KEY (CODSERVICO)
			REFERENCES SERVICOS (CODSERVICO)
)
INSERT INTO CONTRATO
VALUES
(1234,	3,	1,	'E',	'2012-10-15'),
(1234,	3,	3,	'E',	'2012-10-15'),
(1234,	3,	3,	'A',	'2012-10-16'),
(1234,	3,	1,	'A',	'2012-10-16'),
(2468,	4,	4,	'E',	'2012-11-20'),
(2468,	4,	4,	'A',	'2012-11-21'),
(6170,	6,	2,	'E',	'2012-12-18'),
(6170,	6,	5,	'E',	'2012-12-19'),
(6170,	6,	2,	'A',	'2012-12-20'),
(6170,	6,	5,	'A',	'2012-12-21'),
(1234,	3,	1,	'D',	'2013-01-10'),
(1234,	3,	3,	'D',	'2013-01-10'),
(1234,	2,	1,	'E',	'2013-01-10'),
(1234,	2,	1,	'A',	'2013-01-11'),
(2468,	4,	4,	'D',	'2013-01-25'),
(7404,	2,	1,	'E',	'2013-01-20'),
(7404,	2,	5,	'E',	'2013-01-20'),
(7404,	2,	5,	'A',	'2013-01-21'),
(7404,	2,	1,	'A',	'2013-01-22'),
(8638,	6,	5,	'E',	'2013-01-25'),
(8638,	6,	5,	'A',	'2013-01-26'),
(7404,	2,	5,	'D',	'2013-02-03')
--OP1
SELECT DISTINCT 
CL.NOMECLIENTE,
P.NOMEPLANO,
C.STATUS,
COUNT(C.STATUS)
 FROM CONTRATO C
INNER JOIN CLIENTE CL ON CL.CODCLIENTE = C.CODCLIENTE
INNER JOIN PLANOS P	ON P.CODPLANO = C.CODPLANO
GROUP BY P.NOMEPLANO,CL.NOMECLIENTE,C.STATUS
HAVING C.STATUS ='D'
ORDER BY CL.NOMECLIENTE ASC
--OP2
SELECT DISTINCT 
CL.NOMECLIENTE,
P.NOMEPLANO,
C.STATUS,
COUNT(C.STATUS)
 FROM CONTRATO C
INNER JOIN CLIENTE CL ON CL.CODCLIENTE = C.CODCLIENTE
INNER JOIN PLANOS P	ON P.CODPLANO = C.CODPLANO
GROUP BY P.NOMEPLANO,CL.NOMECLIENTE,C.STATUS
HAVING C.STATUS ='A' OR C.STATUS ='E'
ORDER BY CL.NOMECLIENTE ASC
--OP3
SELECT DISTINCT
CL.NOMECLIENTE,P.NOMEPLANO,
TEL = CASE 

WHEN ((P.VALPLANO+SUM(S.VALORSERVICO)) > 400)
THEN
	(P.VALPLANO+SUM(S.VALORSERVICO))-((P.VALPLANO+SUM(S.VALORSERVICO))*0.8)

WHEN ((P.VALPLANO+SUM(S.VALORSERVICO)) > 300 AND (P.VALPLANO+SUM(S.VALORSERVICO)) < 400)
THEN
	(P.VALPLANO+SUM(S.VALORSERVICO))-((P.VALPLANO+SUM(S.VALORSERVICO))*0.5)
	WHEN ((P.VALPLANO+SUM(S.VALORSERVICO)) > 200 AND (P.VALPLANO+SUM(S.VALORSERVICO)) < 300)
THEN
	(P.VALPLANO+SUM(S.VALORSERVICO))-((P.VALPLANO+SUM(S.VALORSERVICO))*0.3)

--WHEN ((P.VALPLANO+SUM(S.VALORSERVICO)) < 200)
--THEN
ELSE
	(P.VALPLANO+SUM(S.VALORSERVICO))
END
FROM CONTRATO C
INNER JOIN PLANOS P ON P.CODPLANO = C.CODPLANO
INNER JOIN SERVICOS S ON S.CODSERVICO = C.CODSERVICO
INNER JOIN CLIENTE CL ON CL.CODCLIENTE = C.CODCLIENTE
WHERE C.STATUS = 'A'
GROUP BY CL.NOMECLIENTE,P.NOMEPLANO,P.VALPLANO,S.VALORSERVICO
--OP4
--CLIENTES QUE NUNCA CANCELARAM NENHUM PLANO						
SELECT DISTINCT CL.NOMECLIENTE,S.NOMESERVICO,DATEDIFF(MONTH,MIN(C.DAT),GETDATE()) FROM CLIENTE CL
INNER JOIN CONTRATO C ON C.CODCLIENTE = CL.CODCLIENTE
INNER JOIN SERVICOS S ON S.CODSERVICO = C.CODSERVICO
WHERE 
CL.NOMECLIENTE IN(

SELECT CL.NOMECLIENTE FROM CLIENTE CL
INNER JOIN CONTRATO C ON CL.CODCLIENTE = C.CODCLIENTE
INNER JOIN PLANOS P ON P.CODPLANO = C.CODPLANO
INNER JOIN SERVICOS S ON S.CODSERVICO = C.CODSERVICO
GROUP BY CL.CODCLIENTE,CL.NOMECLIENTE,S.NOMESERVICO
HAVING
CL.CODCLIENTE 
IN(
SELECT C.CODCLIENTE FROM CONTRATO C
GROUP BY C.CODCLIENTE
HAVING
CAST(C.CODCLIENTE AS VARCHAR(10))+'-'+
CAST(COUNT(C.CODPLANO)AS VARCHAR(10))+'-'+CAST(COUNT(C.STATUS) AS VARCHAR(10)) IN (

SELECT CAST(C.CODCLIENTE AS VARCHAR(10))+'-'+
CAST(COUNT(C.CODPLANO)AS VARCHAR(10))+'-'+CAST(COUNT(C.STATUS) AS VARCHAR(10)) 
FROM CONTRATO C
GROUP BY C.CODCLIENTE,C.CODPLANO
HAVING
CAST(C.CODCLIENTE AS VARCHAR(10))+'-'+CAST(C.CODPLANO AS VARCHAR(10))+'-'+ 
CAST(COUNT(C.STATUS) AS VARCHAR(10)) IN (
SELECT 
CAST(C.CODCLIENTE AS VARCHAR(10))+'-'+CAST(C.CODPLANO AS VARCHAR(10))+'-'+
CAST(COUNT(C.STATUS) AS VARCHAR(10))
FROM CONTRATO C
WHERE C.STATUS = 'A' OR C.STATUS = 'E'
GROUP BY  C.CODCLIENTE,C.CODPLANO
)
)
)
)
GROUP BY CL.NOMECLIENTE,S.NOMESERVICO,C.DAT